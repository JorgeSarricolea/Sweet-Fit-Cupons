---
import Button from "@/components/buttons/Button.astro";
const { email, cuponCode, expirationDate, applicationDate, userCuponId } =
  Astro.props;
const expirationDateFormatted = new Date(expirationDate).toLocaleDateString(
  "es-ES"
);
const applicationDateFormatted = new Date(applicationDate).toLocaleDateString(
  "es-ES"
);
---

<tr class="text-center" id={userCuponId}>
  <td>{email || "N/A"}</td>
  <td>{cuponCode || "N/A"}</td>
  <td>{expirationDate ? expirationDateFormatted : "N/A"}</td>
  <td>{applicationDate ? applicationDateFormatted : "N/A"}</td>
  <td class="">
    {
      applicationDate ? (
        "Cupón validado"
      ) : cuponCode ? (
        <Button description="Validar cupón" importance="secondary" />
      ) : (
        <Button
          className={"send-coupon-btn"}
          params={userCuponId}
          description="Enviar cupón"
          importance="primary"
        />
      )
    }
  </td>
  <td>
    <i
      class="delete-user-coupon-btn fa-solid fa-trash text-primary text-2xl cursor-pointer hover:text-secondary"
      data-userCuponId={userCuponId}
    >
    </i>
  </td>
</tr>

<script>
  import {
    deleteUsersCupon,
    sendCoupon,
  } from "@/js/handlers/handlerUsersCupons.js";

  document.addEventListener("DOMContentLoaded", function () {
    const deleteIcons = document.querySelectorAll(".delete-user-coupon-btn");
    const sendButtons = document.querySelectorAll(".send-coupon-btn");

    deleteIcons.forEach((deleteIcon) => {
      deleteIcon.addEventListener("click", async function () {
        const userCuponId = deleteIcon.getAttribute("data-userCuponId");

        if (userCuponId) {
          try {
            await deleteUsersCupon(userCuponId);
          } catch (error) {
            console.log("Failed to delete user-cupon association:", error);
          }
        } else {
          console.log("Failed to delete: userCuponId is undefined");
        }
      });
    });

    sendButtons.forEach((sendButton) => {
      sendButton.addEventListener("click", async function () {
        const userCuponId = sendButton.getAttribute("data-params");

        if (userCuponId) {
          try {
            await sendCoupon(userCuponId);
            location.reload();
          } catch (error) {
            console.log("Failed to send coupon:", error);
          }
        } else {
          console.log("Failed to send: userCuponId is undefined");
        }
      });
    });
  });
</script>
